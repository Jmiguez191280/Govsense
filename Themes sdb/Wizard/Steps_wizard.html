<style>
    #wizard-body {
        background: linear-gradient(to bottom, #333, #f1f1f1) !important;
        color: #000;
        position: relative;
        height: 100%;
        min-height: 500px;
        padding: 150px 0;
        width:100%;
    }
    
        #recapchaalert {
            visibility: initial!important;
            margin-top: 40px;
        }
   
    #wizard-body #renewals-steps-container a.next {
        background: red;
        border: none;
        border-radius: 0px;
        padding: 10px 20px 10px 20px;
        margin-top: 20px;
        color: #fff;
    }
    .progress-bar.progress-bar-success {
    background-color: #337ab7 !important;
}
    
    #wizard-body #renewals-steps-container a.next:hover {
        background: transparent;
        border: 1px solid red;
        cursor: pointer;
    }
    
    #wizard-body #renewals-steps-container a.prev {
        background: gray;
        border: none;
        border-radius: 0px;
        padding: 10px 20px;
        margin: 20px 20px 0 0;
        color: #fff;
    }
    
    #wizard-body #renewals-steps-container a.prev:hover {
        background: transparent;
        border: 1px solid gray;
        cursor: pointer;
    }
    
    #wizard-body #renewals-steps-container .well {
        background: #929292;
        border-radius: 0;
        border: none;
        color: #000;
    }
    
    #wizard-body #renewals-steps-container .well label {
        color: #fff;
    }
    
    #wizard-body #renewals-steps-container .well #radiosBtns {
        background: #fff;
        padding: 20px;
    }
    
    #wizard-body #renewals-steps-container #step2 #radiosBtns label {
        color: #000;
        margin-left: 6px;
    }
    
    #wizard-body #renewals-steps-container .container {
        padding: 0 19%;
    }
    
    #wizard-body #renewals-steps-container .nav {
        background: #d2d2d2;
    }
    
    #wizard-body #renewals-steps-container .nav.nav-pills>li>a {
        border-radius: 0;
    }
</style>
<script type="application/javascript" src="https://api.ipify.org?format=jsonp&callback=getIP"></script>


<div id="wizard-body">
    <!-- Services Section -->
    <div id="renewals-info-section" class="text-center">
        <div class="container">
            <div class="section-title center">
                <h2> Business Tax Renewal Landing Page </h2>
                <div class="clearfix"></div>
                <p>Thank you for chooseing to renew your Business Tax Receipt online. You can renew your business tax in three simple steps. </p>
                <hr>
            </div>
            <div class="space"></div>
            <div class="row">
                <div class="col-md-12 col-sm-12 service">
                    <i class="fa fa-check-circle"></i>
                    <p> Step 1: Enter your renewal ID found on your Business Tax Receipt Renewal Letter. </p>
                </div>
                <div class="col-md-12 col-sm-12 service">
                    <i class="fa fa-check-circle"></i>
                    <p> Step 2: Confirm your business information. </p>
                </div>
                <div class="col-md-12 col-sm-12 service">
                    <i class="fa fa-check-circle"></i>
                    <p> Step 3: Complete payment with the City's Payment provider. Your new Business Tax Receipt will then be sent to you. </p>
                </div>
            </div>
        </div>
    </div>
    <div id="renewals-steps-container">
        <div class="container" id="myWizard">

            <script>
                function prevStep() {
                    jQuery('[href=#' + 'step1' + ']').tab('show');
                }

                function prevStep3() {
                    jQuery('[href=#' + 'step2' + ']').tab('show');
                }
            </script>
            <div class="progress">
                <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="3" style="width: 33%;">
                    Step 1 of 3
                </div>
            </div>

            <div style="display:none;" class="navbar">
                <div class="navbar-inner">
                    <ul class="nav nav-pills">
                        <li id="stp_1" class="active"><a href="#step1" data-toggle="tab" data-step="1">Step 1</a></li>
                        <li><a id="stp_2" href="#step2" data-toggle="tab" data-step="2">Step 2</a></li>
                        <li><a id="stp_3" href="#step3" data-toggle="tab" data-step="3">Step 3</a></li>

                    </ul>
                </div>
            </div>
            <div class="tab-content">
                <div class="tab-pane fade in active" id="step1">

                    <div class="well">

                        <label>Business Tax Receipt Renewal ID</label>
                        <input id="invid" class="form-control">

                    </div>
                    <a class="next" href="#">Next ></a>

                    <div style="margin-top:35px;" id="html_element"></div>
                    <div class="alert alert-error alert-danger alert-dismissible collapse" role="alert" id="recapchaalert">
                        <strong>ERROR!&nbsp;</strong>reCAPTCHA verification failed. Please Try again.
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                    </div>
                    <script src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit" async defer>
                    </script>
                    
                </div>
                <div class="tab-pane fade" id="step2">
                    <div class="well">

                        <div id="results"></div>

                    </div>
                    <a id="prev1" class="prev">
                        < Previous </a>
                            <a id="btnSubmit" onclick="createCustomRcd();" class="next"> Next > </a>
                </div>
                <div class="tab-pane fade" id="step3">
                    <div class="well">
                        <div id="renderStep3"></div>        
                    </div>
                    <a  id="prev3" onclick="makePayment();" class="next"> Next > </a>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var invIdGlobal = '';
    var ipAddress = '';

    $.getJSON('https://api.ipify.org?format=json', function(data) {
        ipAddress = data.ip
    });
    var onloadCallback = function() {
        debugger
        grecaptcha.render('html_element', {
            'sitekey': '6Lea1wAVAAAAAA20HaKWQMKKjsNeuCC45anRhfmf',
        });
    };

    function validate() {
       
        var captchaSuccess = false;
        var captchaResponse = jQuery('#g-recaptcha-response').val();
        console.log('validate', 'captchaResponse : ' + captchaResponse);
        if (captchaResponse != "") {
            captchaSuccess = true;
        } else {
            jQuery('#recapchaalert').show();
        }
        return captchaSuccess;
    }

     function redirect() {
         debugger
        var invId = jQuery("#invoice").text().trim()
        var customer = jQuery("#customerId").text().trim()
        var optionVal = jQuery('input:radio[name=gender]:checked').val();
        if (optionVal == 'ok') {
            $('[href=#' + 'step3' + ']').tab('show');
            stepThree();
        } else if (optionVal == 'noOk') {
            $('[href=#' + 'step1' + ']').tab('show');
        } else if (optionVal == 'contact') {
            window.location.href = 'https://growthmanagement.ocalafl.org/contact-us.html';
        }
    }

    

    function createCustomRcd() {
   
        if (jQuery('#licInfo')[0]) {
            var renewalId = jQuery('#invoice').text();
            var busName = jQuery('#BusinessName').text();
            var busLicense = jQuery('#name').text();
            var option = jQuery('input:radio[name=gender]:checked').next().text();
            var customer = jQuery("#customerId").text().trim();
            var location=jQuery("#location").text().trim();          
            var jsonData = {
                    customer:customer,
                    renewalId: renewalId,
                    busName: busName,
                    busLicense: busLicense,
                    option: option,
                    ipAddress: ipAddress,
                    location:location
                };       
                localStorage.setItem("jsonData",JSON.stringify(jsonData) );
                redirect();
        } else {
                var jsonData = {
                    renewalId: invIdGlobal,
                    busName: '',
                    busLicense: '',
                    option: '',
                    ipAddress: ipAddress,
                    location:location                 
                };
            }
        jQuery.ajax({
                method: "GET",
                url: "/app/site/hosting/scriptlet.nl?script=244&deploy=1&compid=4778042&h=226ca2f1d50cc6c58f0d&jsonData=" + escape(JSON.stringify(jsonData)),
                cache: false,
                async: true

            })
            .done(function(msg) {
                console.log(msg)
            
            })
    }

    function stepThree(){
           var msg= localStorage.getItem('jsonData');
           if(msg)
           msg=JSON.parse(msg)
            var resultsStr = '<p id="customer_2" style="display:none" >' + msg.customer + '</p>';
                            resultsStr += '<div id="licInfo"><p>Business Name : <span id="BusinessName">' + msg.busName + '</span></p><br>';
                            resultsStr += '<p>Business License : <span id="BusinessName">' + msg.busLicense + '</span></p><br>';
                            resultsStr += '<p>Location :</label><span>  ' + msg.location + '</span></p><br>';
                            resultsStr += '</p>Renewal ID : </label><span> ' + msg.renewalId + ' </span></p></div>';                   
                            jQuery("#renderStep3").html(resultsStr);
        }
        function makePayment(){
            var customer=jQuery("#customer_2").text().trim();
            window.location.href = 'https://checkout.paystand.com/v4/?publishableKey=gn7vb9t26qwlp96wgcbc00uj&viewCheckout=portal-medium&module=ns_openInvoices&extCustomerId=' + customer + '&externalCss=https:%2F%2Fwww.paystand.com%2Fhubfs%2Fcustom_css%2Fcityofocala%2Focala.css&logoUrl=https:%2F%2Fwww.paystand.com%2Fhubfs%2Fcustom_css%2Fcityofocala%2FOcala_Logo_150px.png&drawerType=open_displaced_toggle'
        }

    $(document).ready(function() {

        $('.next').click(function() {
         debugger 
         var option= localStorage.getItem('jsonData');
           if(option){
            option=JSON.parse(option);  
           }
           
            invIdGlobal = jQuery('#invid').val();
            var nextId = $(this).parents('.tab-pane').next().attr("id");
            if(nextId == "step2" && validate()){
                $('[href=#' + nextId + ']').tab('show');
            }else if(option.option == "No, this is not my business. I would like to try again." ){
               return;
            }else{
                $('[href=#' + nextId + ']').tab('show'); 
            }      
            return false;
        })
        $('.prev').click(function() {
            
            var nextId = $(this).parents('.tab-pane').attr("id");
            if (nextId.indexOf('2') != -1) $('[href=#' + 'step1' + ']').tab('show');
            if (nextId.indexOf('3') != -1) $('[href=#' + 'step2' + ']').tab('show');

            return false;
        })

        $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
            //update progress
            
            var step = $(e.target).data('step');

            if (parseInt(step) == 2 && validate()) serachLicense(e)

            var percent = (parseInt(step) / 3) * 100;
            $('.progress-bar').css({
                width: percent + '%'
            });
            $('.progress-bar').text("Step " + step + " of 3");
            //e.relatedTarget // previous tab
        })

        function serachLicense(e) {
            var invoiceID = jQuery('#invid').val().trim();
            jQuery("#results").html('');
            e.preventDefault();
            if (invoiceID) {

                jQuery.ajax({
                        method: "GET",
                        url: "/app/site/hosting/scriptlet.nl?script=243&deploy=1&compid=4778042&h=d58a55c5f38e1a06f31d&invId=" + invoiceID,
                        dataType: "json",
                        cache: false,
                        async: true

                    })
                    .done(function(msg) {
                        if (msg.invoice) {
                            
                            var resultsStr = '<p style="display:none" id="customerId">' + msg.customerId + '</p>';
                            resultsStr += '<div id="licInfo"><p>Business Name : <span id="BusinessName">' + msg.name + '</span></p>';
                            resultsStr += '<p>Business License :<span id="name"> ' + msg.license + '</span></p>';
                            resultsStr += '<p>Location : <span id="location">  ' + msg.location + '</span></p>';
                            resultsStr += '<p >Renewal ID : <span id="invoice"> ' + msg.invoice +' </span></p></div><br>';
                            resultsStr += '<div id="radiosBtns"><p>Please select one of the following options :</p>'
                            resultsStr += '<input  type="radio" id="yesOk" name="gender"  value="ok">'
                            resultsStr += '<label id="label1" for="yesOk" style="float:none;">Yes, this is my business.</label><br>'
                            resultsStr += '<input  type="radio" id="noOk" name="gender"  value="noOk">'
                            resultsStr += '<label for="noOk" style="float:none;">No, this is not my business. I would like to try again.</label><br>'
                            resultsStr += '<input  type="radio" id="contact" name="gender"  value="contact">'
                            resultsStr += '<label for="contact" style="float:none;">I would like to contact the Growth Management Department.</label></div>'
                            jQuery("#results").html(resultsStr);
                            // renderResult(msg)
                        } else {
                            jQuery("#results").html('<p>There are no results for this Renewal ID. Try again.</p>');
                        }
                    })
            }

        }


        $('.first').click(function() {
            
            $('#myWizard a:first').tab('show')

        })


    });
</script>